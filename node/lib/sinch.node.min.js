var PAPI,PUBNUB=require("pubnub").init({}),XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,window=window||global,WRTC=require("wrtc"),navigator=navigator||{mediaDevices:{getUserMedia:function(){return!1},userAgent:""}}||{getUserMedia:function(){return!1},userAgent:""}||{mozGetUserMedia:function(){return!1},userAgent:""}||{webkitGetUserMedia:function(){return!1},userAgent:""},btoa=require("btoa"),atob=require("atob"),localStorage=require("localStorage"),SinchTicketGenerator=require("sinch-ticketgen"),Q=require("q"),SinchVersion=require("../VERSION"),ErrorDomain=(SinchTicketGenerator=require("sinch-ticketgen"),{ErrorDomainNone:-1,ErrorDomainNetwork:0,ErrorDomainCapability:1,ErrorDomainSession:2,ErrorDomainApi:3,ErrorDomainOther:4,ErrorDomainSDK:5,ErrorDomainVerification:7}),ErrorCode={NoneNone:0,NetworkConnectionRefused:1e3,NetworkConnectionTimedOut:1001,NetworkServerError:1002,CapabilityUserNotFound:2e3,CapabilityCapabilityMissing:2001,CapabilityAuthenticationFailed:2002,SessionFailedToInitiateSession:3e3,SessionNoPendingSessionExists:3001,SessionTransferCantBeInitiated:3002,SessionActiveUserLimitReached:3003,ApiApiCallFailed:4e3,OtherInvalidOfflinePayloadTooBig:5e3,OtherInvalidOfflineInvitePayloadFailedToDecode:5001,OtherInvalidOfflineInviteUnknownType:5002,OtherOther:5003,SDKUnexpectedCall:6e3,SDKInternalError:6001,SDKInternalOther:6002,SDKMissingParameter:6003,SDKMissingCallback:6004,VerificationInvalidInput:7001,VerificationServiceError:7002,VerificationIncorrectCode:7003,VerificationFailedToInterceptCode:7004,VerificationUnexpectedInitiateError:7005},sinchAjax=function(e){var t=Q.defer(),i=new XMLHttpRequest;i.onload=function(){if(i.status>=200&&i.status<300){try{i.response=i.response||i.responseText,i.data=JSON.parse(i.response||"{}")}catch(e){console.log("Cant parse JSON"+i.response)}t.resolve(i.data)}else{try{i.response=i.response||i.responseText,i.data=JSON.parse(i.response||"{}")}catch(e){console.log("Cant parse JSON"+i.response)}t.reject(i)}},i.onerror=function(){t.reject(new Error("Unsupported operation "+i.status,i))},i.open(e.method,e.url,!0);for(var n in e.headers)i.setRequestHeader(n,e.headers[n]);return i.send(JSON.stringify(e.data)),t.promise},requestPrototype=function(e,t){var i={method:e.method,headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json, text/plain, */*"}};"GET"!=e.method&&(i.data=t),i.url="";for(var n in e.urlParts){if(":"===e.urlParts[n][0]){var r=e.urlParts[n].slice(1);i.url+=encodeURIComponent((t||{})[r]).replace(/%2B/g,"+").replace(/%40/g,"@")}else i.url+=e.urlParts[n];n<e.urlParts.length-1&&(i.url+="/")}switch(e.auth){case"sign":i.headers=this.signSession(i);break;case"nosign":i.headers=this.signApp(i);break;case"ticket":i.headers=this.signTicket(i),delete i.data.authorization;break;case"signorticket":this._sessionId?i.headers=this.signSession(i):(i.headers=this.signTicket(i),delete i.data.authorization);break;default:throw new Error("Unsupported authentication type: "+e.auth)}if("GET"===e.method&&t&&Object.keys(t).length>0&&!e.hideQueryParams){i.url+="?";for(var s in t)i.url+=encodeURIComponent(s)+"="+encodeURIComponent(t[s])+"&"}return sinchAjax(i)},getUuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})};function Notification(e,t,i,n){this.progress=e/t,this.message=i,this.object=n}function getBrowserInfo(){var e,t=navigator.userAgent,i=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||t.match(/(applewebkit(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(i[1])?"IE "+((e=/\brv[ :]+(\d+)/g.exec(t)||[])[1]||""):"Chrome"===i[1]&&null!=(e=t.match(/\bOPR\/(\d+)/))?"Opera "+e[1]:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/(\d+)/i))&&i.splice(1,1,e[1]),i.join("/").substring(0,50))}function getPlatformInfo(){return navigator.platform}function Sinch(e){if(!e)throw new TypeError("Could not create SinchClient, configuration not provided.");if(e.capabilities=e.capabilities||{},"string"!=typeof e.applicationKey)throw new TypeError("Could not create SinchClient, applicationKey is not a string");this.capabilities=e.capabilities,this._appKey=e.applicationKey||"",this._appSecret=e.applicationSecret||void 0,this._sessionId="",this._sessionSecret="",this._logHandler=e.onLogMessage||function(){},this._logMxpHandler=e.onLogMxpMessage||function(){},this._onlineCapability=e.startActiveConnection||e.supportActiveConnection||!1,this._autoStartMxp=e.startActiveConnection||!1,this._expiresIn=e.expiresIn||86400,this._subInstanceId=Math.round(Math.random()*Math.pow(2,32)),this._customStream=e.customStream||void 0,this._supportVideo=e.capabilities.video||!1,this._multiCall=e.capabilities.multiCall||!1,this.applicationKey=this._appKey,this._supportManagedPush=e.supportManagedPush,this._progressTimeout=e.progressTimeout||10500,this.firefox=!1,void 0!==navigator&&(this.firefox=(navigator||{userAgent:""}).userAgent.indexOf("Firefox")>0),this._url={base:"https://api.sinch.com/v1/",user:"https://userapi.sinch.com/v1/",portal:"https://portalapi.sinch.com/v1/",reporting:"https://reportingapi.sinch.com/v1/",reporting_v2:"https://reportingapi.sinch.com/v2/",calling:"https://callingapi.sinch.com/v1/",messaging:"https://messagingapi.sinch.com/v1/",verification:"https://verificationapi-v1.sinch.com/verification/v1/"},this.setUrl(e.urlObj||{}),this.loadPAPIUrl(),this.loadTimeDelta(),this.user=new User(this),"messaging"in this.capabilities&&this.capabilities.messaging&&(this.messageClient=new MessageClient(this)),"calling"in this.capabilities&&this.capabilities.calling&&(this.callClient=new CallClient(this,e.customStream)),"stealth"in this.capabilities&&this.capabilities.stealth&&(this.callClient=new CallClient(this,e.customStream))}(PAPI=PAPI||{}).base={getServerTime:{url:"timestamp/",method:"GET",auth:"nosign"},getInstance:{url:"instance",method:"POST",auth:"ticket"},renewInstance:{url:"instance",method:"POST",auth:"sign"},renewSecret:{url:"instances/id/:instanceId/authorization",method:"PUT",auth:"ticket"},getInstances:{url:"instances/id/",method:"GET",auth:"sign"}},(PAPI=PAPI||{}).calling={getConfiguration:{url:"configuration/user",method:"GET",auth:"sign"},placeCall:{url:"calls/:domain",method:"POST",auth:"sign"},callReporting:{url:"calls/:domain/id/:callId",method:"PUT",auth:"sign"},postMedia:{url:"media",method:"POST",auth:"sign"},pushCall:{url:"push",method:"POST",auth:"sign"}},(PAPI=PAPI||{}).messaging={getTransportById:{url:"transport",method:"GET",auth:"sign"},getTransportByParticipants:{url:"transport",method:"POST",auth:"sign"},messageReporting:{url:"report/im",method:"POST",auth:"sign"},pushMessage:{url:"push/messages",method:"POST",auth:"sign"}},(PAPI=PAPI||{}).user={authenticate:{url:"users/email/:email/authentication",method:"POST",auth:"nosign"},authenticateUsername:{url:"users/username/:username/authentication",method:"POST",auth:"nosign"},authenticateNumber:{url:"users/number/:number/authentication",method:"POST",auth:"nosign"},createUser:{url:"users",method:"POST",auth:"nosign"},changePassword:{url:"user/password",method:"PUT",auth:"sign"},updateUser:{url:"user/profile",method:"PATCH",auth:"sign"},getUserProfile:{url:"user/profile",method:"GET",auth:"sign"}},(PAPI=PAPI||{}).verification={verify:{url:"verifications",method:"POST",auth:"nosign"},confirmVerification:{url:"verifications/number/:number",method:"PUT",auth:"nosign"},confirmUserCallout:{url:"verifications",method:"POST",auth:"nosign"},confirmFlashCall:{url:"verifications/number/:number",method:"PUT",auth:"nosign"},queryVerificationById:{url:"verifications/callout/number/:number",method:"GET",hideQueryParams:!0,auth:"nosign"}},Sinch.prototype.loadPAPIUrl=function(){this.PAPI=JSON.parse(JSON.stringify(PAPI));for(var e in PAPI)for(var t in PAPI[e])this.PAPI[e][t].urlParts=(this._url[e]+this.PAPI[e][t].url).split("/"),this[t]=requestPrototype.bind(this,this.PAPI[e][t])},Sinch.prototype.loadTimeDelta=function(){var e=Q.defer();return this.timeDelta?e.resolve():this.getServerTime().then(function(t){var i=new Date(t.timestamp),n=new Date;this.timeDelta=i-n,e.resolve()}.bind(this)).catch(function(t){console.error(t),e.fail(t)}),e.promise},Sinch.prototype.config=function(e){this._appKey=e.appKey||this._appKey,this._sessionId=e.sessionId||this._sessionId,this._sessionSecret=e.sessionSecret||this._sessionSecret,localStorage["SinchSDK-"+this._appKey+"-"+this.user.userId]=this._sessionId},Sinch.prototype.loadSessionId=function(){this._sessionId=localStorage["SinchSDK-"+this._appKey+"-"+this.user.userId]||""},Sinch.prototype.log=function(e,t){t&&t.notify(e),this._logHandler(e)},Sinch.prototype.logMxp=function(e){this._logMxpHandler(e)},Sinch.prototype.setUrl=function(e){this._url.user=e.user||this._url.user,this._url.base=e.base||this._url.base,this._url.portal=e.portal||this._url.portal,this._url.reporting=e.reporting||this._url.reporting,this._url.reporting_v2=e.reporting_v2||this._url.reporting_v2,this._url.calling=e.calling||this._url.calling,this._url.messaging=e.messaging||this._url.messaging,this._url.verification=e.verification||this._url.verification,this.loadPAPIUrl()},Sinch.prototype.terminate=function(){try{this.mxp&&this.mxp.close(),this.mxp.destroy(),this.mxp&&delete this.mxp,this._sessionId="",this._sessionSecret="",this.messageClient&&this.messageClient.destroy()}catch(e){}},Sinch.prototype.stop=function(){console.error("Stop is deprecated, use terminate() instead!"),this.terminate()},Sinch.prototype.adjustedTime=function(){var e=(new Date).getTime();return new Date(e+(this.timeDelta||0)).toISOString()},Sinch.prototype.signSession=function(e){try{var t="";if(void 0!==e.data){var i="string"!=typeof e.data?JSON.stringify(e.data):e.data;t=CryptoJS.MD5(i).toString(CryptoJS.enc.Base64)}e.headers["Content-Type"]=(e.headers["Content-Type"]||"").replace("utf-8","UTF-8").replace("/json;chars","/json; chars"),e.headers["X-Timestamp"]=e.headers["X-Timestamp"]||this.adjustedTime();var n=e.method+"\n"+t+"\n"+(e.headers["Content-Type"]||"")+"\nx-timestamp:"+e.headers["X-Timestamp"]+"\n"+e.url.match(/^https?:\/\/[^\/]+([^#]*)/)[1];if(this._sessionId.length>0&&this._sessionSecret.length>0){var r=CryptoJS.HmacSHA256(CryptoJS.enc.Utf8.parse(n),CryptoJS.enc.Base64.parse(this._sessionSecret)).toString(CryptoJS.enc.Base64);e.headers.Authorization="instance "+this._sessionId+":"+r}else e.headers.Authorization="application "+this._appKey;return e.headers}catch(e){throw e}return null},Sinch.prototype.signTicket=function(e,t){return t=t||e.data.authorization,e.headers=e.headers||{},e.headers.Authorization="user "+t,e.headers["X-Timestamp"]=this.adjustedTime(),e.headers},Sinch.prototype.signApp=function(e){try{return e.headers["X-Timestamp"]=e.headers["X-Timestamp"]||this.adjustedTime(),e.headers.Authorization="application "+this._appKey,e.headers}catch(e){throw e}return null},Sinch.prototype.getSession=function(){return{userId:this.user.userId,sessionId:this._sessionId,sessionSecret:this._sessionSecret,pushNotificationDisplayName:this.user.pushNotificationDisplayName}},Sinch.prototype.newUser=function(e,t,i){var n=Q.defer();return t=t||function(e){return console.info("User successfully created"),e},i=i||function(e){console.error(e)},this.user.create(e).then(t).then(n.resolve).fail(function(e){this.log(e),i(e),n.reject(e)}.bind(this)),n.promise},Sinch.prototype.start=function(e,t,i){var n=Q.defer();if(t=t||function(){this.log(new Notification(0,1,"SinchClient started"))}.bind(this),i=i||function(e){console.error(e)},this.started){var r=new Error("Sinch client already started");i(r),n.reject(r)}else e&&(this.user.pushNotificationDisplayName=e.pushNotificationDisplayName),this.started=!0,this.loadTimeDelta().then(function(e){return this.log(new Notification(0,5,"Get authentication token"),n),this.user.authenticate(e)}.bind(this,e),e).then(function(e){return this.loadSessionId(),e}.bind(this)).then(function(e){return this.log(new Notification(1,5,"Get instance using auth token"),n),e&&e.sessionId&&e.sessionSecret?this.user.resumeSession(e):this.user.initSessKeySecret()}.bind(this)).fail(function(e){if(40400===((e||{response:{}}).response||{}).errorCode)return this.log(new Notification(1,5,"Invalid instance. Will try again without any pre-set instance ID."),n),this._sessionId="",this.user.initSessKeySecret();throw e}.bind(this)).then(function(){return this.log(new Notification(2,5,"Get MXP configuration"),n),this.user.getMXPConf()}.bind(this)).then(function(){this.log(new Notification(3,5,"Create MXP object"),n),this.mxp=new MXP(this)}.bind(this)).then(function(){if(this._autoStartMxp&&(void 0!==this.messageClient||void 0!==this.callClient))return this.log(new Notification(4,5,"Will start active connection"),n),this.startActiveConnection();this.log(new Notification(4,5,"Will NOT start active connection. This will prevent IM and incoming data calls."),n)}.bind(this)).then(t).then(function(){this.log(new Notification(5,5,"Successfully started SinchClient"),n),n.resolve()}.bind(this)).fail(function(e){this.started=!1,this._sessionId="",this._sessionSecret="",this.log(e),i(e),n.reject(e)}.bind(this));return n.promise},Sinch.prototype.getMessageClient=function(){if("messaging"in this.capabilities&&this.capabilities.messaging)return this.messageClient;throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"No messaging capability, not possible to retrieve messageClient")},Sinch.prototype.getCallClient=function(){if("calling"in this.capabilities&&this.capabilities.calling)return this.callClient;throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"No calling capability, not possible to retrieve callClient")},Sinch.prototype.createSmsVerification=function(e,t){return new Verification(this,e,t,"sms")},Sinch.prototype.createCalloutVerification=function(e,t){return new CalloutVerification(this,e,t)},Sinch.prototype.createFlashCallVerification=function(e,t){return new Verification(this,e,t,"flashcall")},Sinch.prototype.createVerification=function(e,t,i){return new Verification(this,e,t,i.toLowerCase())},Sinch.prototype.startActiveConnection=function(){if(this._onlineCapability&&this.started)return this.log(new Notification(4,5,"Manually starting active connection")),this.mxp.init();if(!this._onlineCapability)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,'No online capability, can not start active connection. Set configuration option "supportActiveConnection" to "true" when instantiating the SinchClient');this._autoStartMxp=!0},Sinch.prototype.stopActiveConnection=function(){if(this._onlineCapability)return this.log(new Notification(4,5,"Manually closing active connection")),this.mxp.close();throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,'No online capability, can not start active connection. Set configuration option "supportActiveConnection" to "true" when instantiating the SinchClient')},Sinch.prototype.getVersion=function(){try{return SinchVersion.version[1]}catch(e){return"dev"}},Sinch.prototype.onnotification=function(e,t){};var PeerConnection,SessionDescription,IceCandidate,SinchClient=Sinch;WRTC=WRTC||{};function Call(e,t,i){this.sinch=e,this.eventListeners=[],this.callId=i||getUuid(),this.callDomain="None",this.callOutbound=void 0,this.fromId="",this.toId="",this.webRtcConfig={iceServers:[{urls:["stun:23.21.150.121","stun:stun.l.google.com:19302"]}]};var n=navigator.userAgent.match(/Chrom[e|ium]\/([0-9]+)\./),r=!!n&&parseInt(n[1],10),s=navigator.userAgent.match(/Firefox\/([0-9]+)\./),o=!!s&&parseInt(s[1],10);(r>=48||o>=42)&&(this.sinch.log(new Notification(0,1,"Chrome >= 48 or FF >= 42 detected, will generate certificate manually for better compatibility")),PeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(function(e){this.sinch.log(new Notification(0,1,"New certificate generated and configured!")),this.webRtcConfig.certificates=[e]}.bind(this))),this.outgoingStream=void 0,this.outgoingStreamURL=void 0,this.incomingStream=void 0,this.incomingStreamURL=void 0,this.earlymedia=void 0,this.callState=CallState.INITIATING,this.callEndCause=CallEndCause.NONE,this.timeProgressing=null,this.timeEstablished=null,this.timeEnded=null,this.error=null,this.autoAnswer=!1,this.autoHangup=!1,this.videoSupport=t||!1,this.clientMap={},this.instanceMap={},this.sdpMap={},this.iceMapRx={},this.iceMapTx=[],this.activeInstance=void 0,this.pcMap={},this.dataChannels={},this.proxyUrl=void 0,this.customHeaders=void 0,this.sdpAnswerBuffer={},this.joinBuffer={};var a={onCallEnded:function(e){this.sinch.mxp.unsubscribe("signalPubNub")}.bind(this)};this.addEventListener(a);var c="web",l="0";try{c=getBrowserInfo().split("/")[0],l=getBrowserInfo().split("/")[1]}catch(e){}var h={onCallEnded:function(t){var i=t.getDetails();if(i.startedTime){var n={callId:t.callId,domain:t.callDomain,outbound:t.callOutbound,fromId:t.fromId,toId:t.toId,callTime:new Date(i.startedTime).toISOString(),duration:i.duration,setupDuration:(t.timeEstablished-t.timeProgressing)/1e3||0,result:t.callEndCause,deviceInformation:{ModelId:getPlatformInfo()||"unknown",OSName:c,OSVersion:l,SDKPlatform:"js",SDKPlatformVersion:e.getVersion()}};t.sinch.callReporting(n).fail(function(){console.error("Could not report call!")})}t.ffIceTimer&&clearInterval(t.ffIceTimer)}};this.addEventListener(h)}function PushPayload(e,t,i,n,r){this._version=e,this._type=t,this._sessionId=i,this._created=n,this._externalId=r,this._bytes=[],this.Encoded=function(){return this.encodeChar(this._version),this.encodeChar(this._type),this.encodeSessionId(this._sessionId),this.encodeTimestamp(this._created/1e3),this.encodeChar(this.getUserIdTypeAndLength(0,this._externalId.length)),this.encodeString(this._externalId),this.base64Encode()},this.encodeChar=function(e){this._bytes.push(e)},this.encodeSessionId=function(e){var t=0;for(this._bytes.push(e==e.toLowerCase()?1:2);t<e.length;)"-"!=e.substring(t,t+1)?(this._bytes.push(parseInt(e.substr(t,2),16)),t+=2):++t},this.encodeTimestamp=function(e){this.encodeChar(255&e),this.encodeChar((65280&e)>>8),this.encodeChar((16711680&e)>>16),this.encodeChar((4278190080&e)>>24)},this.encodeString=function(e){for(var t=0;t<e.length;++t)this._bytes.push(e.charCodeAt(t))},this.getUserIdTypeAndLength=function(e,t){return 127&t|e<<7},this.base64Encode=function(){for(var e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),i=this._bytes,n="",r=0;r<i.length;r+=3)n+=t[i[r]>>2],n+=t[(3&i[r])<<4|i[r+1]>>4],void 0!==i[r+1]?n+=t[(15&i[r+1])<<2|i[r+2]>>6]:n+="=",void 0!==i[r+2]?n+=t[63&i[r+2]]:n+="=";for(e=n.slice(0,64),r=1;r<Math.ceil(n.length/64);r++)e+=n.slice(64*r,64*r+64)+(Math.ceil(n.length/64)==r+1?"":"\n");return e}}function CallDetails(e){this.endCause=e.endCause,this.endedTime=e.endedTime,this.error=e.error,this.establishedTime=e.establishedTime,this.startedTime=e.startedTime,this.duration=e.duration}function CallClient(e,t){if(!(e instanceof Sinch))throw new Error("CallClient can't be instantiated, use getCallClient in an SinchClient instance");var i=navigator.userAgent.toLowerCase();if(i.indexOf("msie")>-1||/Apple Computer/.test(navigator.vendor)||/Edge/.test(i))throw new Error("SinchClient can't be started with calling capability. Browser not supported.");this.sinch=e,this.eventListeners=[],this.callBuffert={},this.localMediaStream=void 0,this.incomingCallCustomStream=t,this.groupChannel=void 0}PeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||WRTC.RTCPeerConnection,SessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription||WRTC.RTCSessionDescription,IceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||WRTC.RTCIceCandidate,Call.prototype.addEventListener=function(e){this.eventListeners.push(e)},Call.prototype.removeEventListener=function(e){this.eventListeners.splice(this.eventListeners.indexOf(e),1)},Call.prototype.setStream=function(e){this.outgoingStream=e,this.outgoingStreamURL=window.URL.createObjectURL(e),this.execListener("onLocalStream",e)},Call.prototype.execListener=function(e,t){this.eventListeners.forEach(function(i){try{return i[e]&&i[e](this,t)}catch(t){var n=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing listener: "+e,t);throw console.error(n),n}}.bind(this))},Call.prototype.setEndCause=function(e){this.callEndCause===CallEndCause.NONE&&(this.callEndCause=e)},Call.prototype.setParticipants=function(e,t){this.callOutbound=e==this.sinch.user.userId,this.toId=t,this.fromId=e},Call.prototype.progress=function(e){if(this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Progress: Invalid call state for progressing",Call);this.sinch.log(new Notification(0,1,"Call changing state to PROGRESSING")),this.timeProgressing=new Date,this.callState=CallState.PROGRESSING,e&&this.execListener("onCallProgressing"),this.autoAnswer&&this.answer(),this.autoHangup&&this.hangup()},Call.prototype.establish=function(){if(this.callState==CallState.PROGRESSING){this.sinch.log(new Notification(0,1,"Call changing state to ESTABLISHED")),this.pc=this.pc||this.pcMap[this.activeInstance]||this.pcMap.virtual,delete this.pcMap.virtual;for(var e in this.pcMap)e!=this.activeInstance&&this.pcMap[e]!=this.pcMap[this.activeInstance]&&(this.pcMap[e]&&"closed"!=this.pcMap[e].signalingState&&this.pcMap[e].close(),delete this.pcMap[e]);"connection"!=this.callDomain&&(this.unmute(),this.incomingStream=this.pc.getRemoteStreams()[0],this.incomingStreamURL=window.URL.createObjectURL(this.incomingStream)),this.timeEstablished=new Date,this.callState=CallState.ESTABLISHED,this.execListener("onCallEstablished")}else console.log("Call state not in PROGRESSING, cant process second JOIN")},Call.prototype.push=function(e){if(!this.sinch._supportManagedPush)return!1;if(this.callState!=CallState.INITIATING&&this.callState!=CallState.PROGRESSING)return!1;var t=[];for(key in this.instanceMap)this.instanceMap[key].capabilities&&this.instanceMap[key].capabilities.indexOf("push")>-1&&(!e&&this.instanceMap[key].capabilities.indexOf("online")<0||e&&this.instanceMap[key].capabilities.indexOf("online")>-1)&&t.push(key);if(t.length>0){var i=new PushPayload(2,1,this.callId,Date.now(),this.sinch.user.userId),n={};n.sinch=i.Encoded(),this.sinch.user.pushNotificationDisplayName&&(n.displayName=this.sinch.user.pushNotificationDisplayName);for(var r={sessionId:this.callId,template:"incoming_call",to:[],params:n},s=0;s<t.length;++s)r.to.push({instance:t[s]});this.sinch.pushCall({messages:[r]}),this._callPushed=!0,this.progress(!0)}return this._callPushed},Call.prototype.createInstanceMap=function(e){if(!e)return null;for(var t={},i=0;i<e.length;++i)t[e[i].instanceId]={},t[e[i].instanceId].capabilities=e[i].capabilities;return t},Call.prototype.mxpAck=function(e){if(this.sinch.log(new Notification(0,1,"Call ACK Received",e)),this.callState!=CallState.INITIATING&&this.callState!=CallState.PROGRESSING)throw new SinchError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Invalid call state for processing Ack",Call);this.clientMap[e.getSenderId()]=this.clientMap[e.getSenderId()]||e.getFrom(),this.instanceMap&&this.instanceMap[e.getInstanceId()]&&(this.instanceMap[e.getInstanceId()].acked=!0);for(var t=0;t<this.iceMapTx.length;t++){var i=this.iceMapTx[t];this.sinch.log(new Notification(0,1,"Firefox special: Transmitting buffered ICE candidates for the one Peer Connection we have.",i)),this.sinch.mxp.callTxICECandidate(this,i,e.fi).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending ICE candidate")})}this.processRTCAnswer(e).then(function(){"yes"===(e.decrypted.nvps||{}).earlymedia?(this.activeInstance=e.getSenderId(),this.progress(!1),this.establish(),this.earlymedia=!0):this.progress(!0),this.joinBuffer[e.getSenderId()]&&(this.sinch.log(new Notification(0,1,"Buffered JOIN was detected for this Ack, will immediatley process & remove.")),this.mxpJoin(this.joinBuffer[e.getSenderId()]),delete this.joinBuffer[e.getSenderId()])}.bind(this))},Call.prototype.intProcessAnswer=function(e,t){var i=Q.defer();return this.sinch.log(new Notification(2,2,"Will configure SDP Answer",e)),this.pcMap[t].setRemoteDescription(e,function(){this.sinch.log(new Notification(2,2,"Configured incoming SDP Answer",e)),i.resolve()}.bind(this),function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP",e)}.bind(this)),i.promise},Call.prototype.processRTCAnswer=function(e){var t=Q.defer();if(this.callState!=CallState.ENDED){var i="media"==e.decrypted.bt?null:e.decrypted.bd;this.sinch.log(new Notification(0,2,"Processing SDP Answer from B",i));var n=i?new SessionDescription(JSON.parse(i)):null;if(this.sinch.firefox)this.pcMap[e.getSenderId()]=this.offerGeneratorPC,this.sdpAnswerBuffer[e.getSenderId()]=RTCdescription,t.resolve();else{this.pcMap[e.getSenderId()]=this.pcMap[e.getSenderId()]||this.initPC();var r=this.pcMap[e.getSenderId()];r.createOffer(function(i){r.setLocalDescription(this.outgoingOffer,function(){this.sinch.log(new Notification(1,2,"Configured cached outgoing SDP Offer",this.outgoingOffer)),n?this.intProcessAnswer(n,e.getSenderId()).then(function(){t.resolve()}):t.resolve()}.bind(this),function(e){console.error("Error setting local Description, message: "+e)})}.bind(this),function(e){console.error("Error creating offer, message: "+e)},{offerToReceiveAudio:!0,offerToReceiveVideo:this.videoSupport})}}else t.resolve();return t.promise},Call.prototype.mxpPeerEventSdp=function(e){if(this.callState==CallState.INITIATING||this.callState==CallState.PROGRESSING)this.disableIce=!0,this.processRTCAnswer(e);else if(this.callState==CallState.ESTABLISHED){var t=JSON.parse(e.decrypted.bd);if("offer"==t.type){this.sinch.log(new Notification(0,3,"Got renegotiation SDP Offer",t));var i=new SessionDescription(t);this.pc.setRemoteDescription(i,function(){this.sinch.log(new Notification(1,3,"Successfully configured SDP Offer.",t)),this.pc.createAnswer(function(t){this.pc.setLocalDescription(t,function(){this.sinch.log(new Notification(2,3,"Successfully created SDP Answer.",t)),this.sinch.mxp.callTxPeerEventSDP(this,t,e.getSenderId()).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Answer")})}.bind(this),function(e){console.error("Major error in setting local description",e)})}.bind(this),function(e){console.error("Major error in creating answer",e)})}.bind(this),function(e){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,e),this.sinch.mxp.callCancel(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")}.bind(this))}else if("answer"==t.type){this.sinch.log(new Notification(0,2,"Got renegotiation SDP Answer",t));i=new SessionDescription(t);this.pc.setRemoteDescription(i,function(){this.sinch.log(new Notification(1,2,"Configured incoming SDP Answer",t))}.bind(this),function(e){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,e),this.sinch.mxpCancel(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")})}}},Call.prototype.mxpInjectIce=function(e){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,2,"Recieved ICE Candidate offer from B",e));var t=JSON.parse(e.decrypted.bd);t.candidate=t.cand||t.candidate,t.sdpMLineIndex=t.sdpMLI||t.sdpMLineIndex;var i=e.getSenderId();!this.sinch.firefox&&i in this.pcMap?(this.sinch.log(new Notification(0,2,"Injecting ICE candidate directly",t)),this.injectIce(i,t)):(this.sinch.log(new Notification(0,2,"Buffering ICE candidate until PeerConnection created",t)),this.iceMapRx[i]=this.iceMapRx[i]||[],this.iceMapRx[i].push(t))}},Call.prototype.injectIce=function(e,t){var i=t.candidate.split(" ");if(-1!=i.indexOf("srflx")&&"udp"==i[2].toLowerCase()){var n={candidate:["candidate:"+(123+(this.pcMap[e].proxyIce||[]).length),i[1],i[2].toUpperCase(),Math.round(i[3]/10),this.proxyUrl.split("/")[3].split(":")[0],this.proxyUrl.split("/")[3].split(":")[1],"typ","relay","raddr",i[4],"rport",i[5],"generation",0].join(" "),sdpMLineIndex:"number"==typeof t.sdpMLI?t.sdpMLI:t.sdpMLineIndex||0,sdpMid:t.sdpMid};this.sinch.log(new Notification(0,1,"Generated extra candidate for Proxy Relay",n)),void 0===this.pcMap[e].proxyIce&&(this.pcMap[e].proxyIce=[]),this.pcMap[e].proxyIce.push(new IceCandidate(n))}this.pcMap[e].addIceCandidate(new IceCandidate(t),function(){},function(){})},Call.prototype.addRelay=function(e){if(0==((this.pcMap[e]||{}).proxyIce||[]).length)if(console.error("Warning, no proxy configured (2). Will try to add candidate without srflx reference",this.pcMap[e]),this.proxyUrl){var t=this.proxyUrl.split("/")[3].split(":");this.pcMap[e].proxyIce=this.pcMap[e].proxyIce||[],this.pcMap[e].proxyIce.push(new IceCandidate({sdpMid:"audio",sdpMLI:0,sdpMLineIndex:0,candidate:CallHelper.generateIceCandidate(t[0],t[1])}))}else console.error("Warning, no proxyUrl configured!");((this.pcMap[e]||{}).proxyIce||[]).forEach(function(t){this.sinch.log(new Notification(0,1,"Adding buffered proxy ICE candidate",t)),this.pcMap[e].addIceCandidate(t,function(){this.sinch.log(new Notification(0,1,"Successfully added proxy ICE candidate",t))}.bind(this),function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Failed to add proxy ICE candidate when processing JOINED",e)})}.bind(this))},Call.prototype.mxpJoin=function(e){if(this.sinch.log(new Notification(0,1,"Call JOIN Received",e)),this.activeInstance&&this.activeInstance!=e.getSenderId())throw console.error("Can not process JOIN, call in session after previous JOIN"),new SinchError(ErrorDomain.ErrorDomainSession,ErrorCode.SessionActiveUserLimitReached,"Can not process JOIN, call in session after previous JOIN");var t=e.getSenderId();this.callState==CallState.INITIATING?(this.sinch.log(new Notification(0,1,"JOIN received before ACK. Will cache JOIN to process after ACK.")),this.joinBuffer[t]=e):Q.fcall(function(){var i=Q.defer();if("sdp"===e.decrypted.bt&&this.pcMap[t]&&""==this.pcMap[t].remoteDescription.sdp){var n=JSON.parse(e.decrypted.bd),r=new SessionDescription(n);this.sinch.firefox?this.sdpAnswerBuffer[t]=r:this.pcMap[t].setRemoteDescription(r,function(){this.sinch.log(new Notification(1,2,"Configured incoming SDP Join",n)),i.resolve()}.bind(this),function(e){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,e),this.sinch.mxpCancel(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")})}else i.resolve();return i.promise}.bind(this)).then(Q.fcall(function(){var i=Q.defer();if(this.sinch.firefox&&this.sdpAnswerBuffer[t]){var n=this.sdpAnswerBuffer[t];this.intProcessAnswer(n,e.getSenderId()).then(function(){for(;(this.iceMapRx[t]||[]).length;){var n=this.iceMapRx[t].pop();this.injectIce(e.getSenderId(),n),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",n))}setTimeout(function(){i.resolve()}.bind(this),200)}.bind(this))}else i.resolve();return i.promise}.bind(this)).then(function(){if(this.pcMap[t]&&(this.sinch.log(new Notification(0,1,"Remote description:",this)),this.pcMap[t].remoteDescription&&this.pcMap[t].remoteDescription.sdp.includes("a=candidate:")||this.addRelay(t)),this.callState!=CallState.PROGRESSING&&!this.earlymedia)throw console.error("Can not process JOIN, call in unexpected state. Call state: "+this.getState()),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not process JOIN, call in unexpected state.");this.activeInstance=e.getSenderId(),this.sinch.mxp.callJoined(this).then(function(){this.sinch.log(new Notification(0,1,"Successfully sent JOINED",this)),this.earlymedia||this.establish()}.bind(this)).fail(function(e){console.error("Unhandled error in call.mxpJoin.",e)})}.bind(this))).fail(function(e){console.error("Error processing JOIN",e)})},Call.prototype.mxpJoined=function(e){if(this.sinch.log(new Notification(0,1,"Call JOINED Received",e)),this.callState==CallState.INITIATING||this.callState==CallState.PROGRESSING){if(JSON.parse(e.decrypted.bd).fi!=this.sinch._sessionId+":"+this.sinch._subInstanceId)this.setEndCause(CallEndCause.OTHER_DEVICE_ANSWERED),this.mxpHangup();else if(this.callState==CallState.PROGRESSING){var t=e.getSenderId();if(this.sinch.firefox)for(;(this.iceMapRx[t]||[]).length;){var i=this.iceMapRx[t].pop();this.injectIce(e.getSenderId(),i),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",i))}this.addRelay(t),this.establish()}}else console.log("Call state already ESTABLISHED (or ENDED), cant process second JOIN")},Call.prototype.mxpHangup=function(e){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,1,"Call HANGUP Received",e)),this.callState==CallState.ESTABLISHED?this.setEndCause(CallEndCause.HUNG_UP):this.setEndCause(CallEndCause.CANCELED),this.timeEnded=new Date,this.callState=CallState.ENDED,this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var t in this.pcMap)delete this.pcMap[t]}},Call.prototype.mxpDeny=function(e){if(this.callState!=CallState.ENDED){if(this.sinch.log(new Notification(0,1,"Call DENIED Received",e)),this.setEndCause(CallEndCause.DENIED),"error/json"==e.decrypted.bt){this.error=new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,"");var t=JSON.parse(e.decrypted.bd);for(var i in t)this.error[i]=t[i];this.error.message=t.code+" "+t.reason,this.error.mxp=e.decrypted}this.callState==CallState.INITIATING?(this.autoHangup=!0,this.progress(!0)):this.hangup()}},Call.prototype.mxpCancel=function(e){if(this.callState!=CallState.ENDED){this.sinch.log(new Notification(0,1,"Call CANCEL Received",e)),this.timeEnded=new Date,this.callState=CallState.ENDED;Date.now();this.setEndCause(CallEndCause.CANCELED),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var t in this.pcMap)delete this.pcMap[t]}},Call.prototype.mxpFail=function(e){if(this.sinch.log(new Notification(0,1,"Call FAILURE Received",e)),"message"==e.decrypted.bt)this.error=new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,""),this.error.message=e.decrypted.bd,this.error.mxp=e.decrypted;else if("error/json"==e.decrypted.bt){this.error=new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,"");var t=JSON.parse(e.decrypted.bd);for(var i in t)this.error[i]=t[i];this.error.message=t.code+" "+t.reason,this.error.mxp=e.decrypted}this.callFailure()},Call.prototype.callFailure=function(){this.timeEnded=new Date,this.callState=CallState.ENDED,this.setEndCause(CallEndCause.FAILURE),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var e in this.pcMap)delete this.pcMap[e]},Call.prototype.addEventListenerPrototype=function(e){e.onOpen&&(this.onopen=e.onOpen),e.onClose&&(this.onclose=e.onClose),e.onMessage&&(this.onmessage=e.onMessage)},Call.prototype.initPC=function(e){var t=new PeerConnection(this.webRtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});return this.outgoingStream&&"connection"!=this.callDomain?(this.mute(),t.addStream(this.outgoingStream)):(this.sinch.log(new Notification(0,1,"WebRTC: Will add data channel before ICE negotiation")),this.dataChannels[this.sinch.user.userId]=t.createDataChannel(this.sinch.user.userId,{reliable:!1}),this.dataChannels[this.sinch.user.userId].onmessage=function(e){console.log("fallback",e)},this.dataChannels[this.sinch.user.userId].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[this.sinch.user.userId])),t.ontrack=function(e){this.execListener("onRemoteTrack",this.incomingStream)}.bind(this),t.ondatachannel=function(e){this.sinch.log(new Notification(0,1,"WebRTC: Datachannel opened",e));try{this.dataChannels[e.channel.label]=e.channel,this.dataChannels[e.channel.label].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[e.channel.label]),this.execListener("onDataChannelAdded",this.dataChannels[e.channel.label])}catch(e){console.error("Error handling datachannel",e)}}.bind(this),t.oniceconnectionstatechange=function(e){this.sinch.log(new Notification(0,1,"WebRTC: Connection state changed",e)),this.renegotiate||!e.currentTarget||"failed"!=e.currentTarget.iceConnectionState&&"disconnected"!=e.currentTarget.iceConnectionState||(this.sinch.log(new SinchError(ErrorDomain.ErrorDomainNetwork,ErrorCode.NetworkConnectionTimedOut,"Ice connection failed. Hanging up call!",e)),this.hangup())}.bind(this),t.onicecandidate=function(e){if(!this.renegotiate&&e.candidate){this.sinch.log(new Notification(0,2,"Preparing ICE candidate for B",e.candidate));var i=Object.keys(this.pcMap).filter(function(e){return this.pcMap[e]===t}.bind(this))[0],n={cand:e.candidate.candidate,candidate:e.candidate.candidate,sdpMLI:e.candidate.sdpMLineIndex,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid||""};setTimeout(function(){i?this.disableIce?this.sinch.log(new Notification(1,2,"ICE Disabled, will not send any ICE candidates (will be sent in different way)",n)):(this.sinch.log(new Notification(1,2,"Instantly sending ICE candidate for B",n)),this.sinch.mxp.callTxICECandidate(this,n,i).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending ICE candidate")})):this.iceMapTx.push(n)}.bind(this),this.sinch.mxp.sessionBuffert[this.callId]?0:500)}}.bind(this),t.onnegotiationneeded=function(e){this.callState==CallState.ESTABLISHED&&(this.renegotiate=!0,this.sinch.log(new Notification(0,2,"Negotiation needed, will generate new offer",e)),t.createOffer(function(e){this.sinch.log(new Notification(1,2,"Negotiation needed, offer generated",e)),t.setLocalDescription(this.outgoingOffer,function(){this.sinch.log(new Notification(1,2,"Negotiation needed, sending offer to recipient",e)),this.sinch.mxp.callTxPeerEventSDP(this,e,this.activeInstance).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Offer")})}.bind(this),function(e){this.sinch.log(new Notification(0,2,"Error setting local description",e))})}.bind(this),function(e){this.sinch.log(new Notification(0,2,"Error generating new offer",e))}))}.bind(this),t.onremovestream=function(e){this.sinch.log(new Notification(0,1,"WebRTC: Stream removed",e))}.bind(this),t.onsignalingstatechange=function(e){this.sinch.log(new Notification(0,1,"WebRTC: Signaling state change",e))}.bind(this),t.onidentityresult=function(e){this.sinch.log(new Notification(0,1,"WebRTC: onidentityresult event detected",e))},t.onidpassertionerror=function(e){this.sinch.log(new Notification(0,1,"WebRTC: onidpassertionerror event detected",e))},t.onidpvalidationerror=function(e){this.sinch.log(new Notification(0,1,"WebRTC: onidpvalidationerror event detected",e))},t.onpeeridentity=function(e){this.sinch.log(new Notification(0,1,"WebRTC: onpeeridentity event detected",e))},t},Call.prototype.placeCall=function(e,t){var i=Q.defer();this.callDomain=t,this.setParticipants(this.sinch.user.userId,e),setTimeout(function(){this.push(!0),this._callPushed||this.callState!=CallState.INITIATING||(this.sinch.log(new Notification(0,1,"Call PROGRESSING timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.TIMEOUT),this.hangup())}.bind(this),this.sinch._progressTimeout||TIMEOUT_CALLPROGRESSING),setTimeout(function(){this.callState==CallState.PROGRESSING&&(this.sinch.log(new Notification(0,1,"Call ESTABLISHED timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.NO_ANSWER),this.hangup())}.bind(this),TIMEOUT_CALLESTABLISHED);var n={cli:"",destination:{type:{pstn:"number",data:"username",conference:"username",connection:"username",sip:"username"}[t],endpoint:e},callId:this.callId,mediaChannels:["audio"],subinstanceId:this.sinch._subInstanceId,headers:{p2p:"yes"},domain:{pstn:"pstn",data:"data",conference:"conference",connection:"data",sip:"sip"}[t]};this.sinch._supportVideo&&n.mediaChannels.push("video"),this.customHeaders&&(n.headers.ph=JSON.stringify(this.customHeaders)),"connection"==t&&(n.headers.nomedia=!0);var r=this.initPC();return r.createOffer(function(t){this.outgoingOffer=t,n.sdp=t,this.sinch.placeCall(n).then(function(n){this.sinch.log(new Notification(0,1,"Successfully initiated call, waiting for MXP signalling.",n)),void 0!==n.SignalChannel&&null!==n.SignalChannel&&(this.clientMap.virtual={fs:n.SignalChannel,fu:e},this.instanceMap=this.createInstanceMap(n.instances),this.push(!1)&&(_callPushed=!0)),this.proxyUrl=n.Body.replace(/(\r\n|\n|\r)/gm,""),this.sinch.firefox&&(this.offerGeneratorPC=r,r.setLocalDescription(t,function(){this.sinch.log(new Notification(0,1,"Firefox special: Configuring the local description to gather ICE candidates.",t))}.bind(this),function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Firefox special: Error configuring local description",e)})),this.sinch.mxp.configureMxpSession(this.callId,n.EncryptionKey,n.Body),i.resolve()}.bind(this)).fail(function(e){this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,JSON.parse(e.response).message),this.callFailure(),i.reject(error)}.bind(this))}.bind(this),function(e){console.error("Failed to generate SDP Offer"),console.error(e)},{offerToReceiveAudio:!0,offerToReceiveVideo:this.videoSupport}),i.promise},Call.prototype.updateSdp=function(e){for(var t=e.split("\n"),i="",n=!1,r=!1,s=0;s<t.length;++s)t[s].length>0&&!t[s].startsWith("a=crypto:1")&&(i=i+t[s]+"\n"),t[s].length>0&&t[s].startsWith("a=mid:")&&(r=!0),t[s].length>0&&t[s].startsWith("a=group:BUNDLE")&&(n=!0);return n||(i+="a=group:BUNDLE audio\n"),r||(i+="a=mid:audio\n"),i},Call.prototype.ackIncomingCall=function(e){var t=Q.defer();this.sinch.log(new Notification(0,1,"Incoming call",this)),setTimeout(function(){this.callState==CallState.INITIATING&&(this.sinch.log(new Notification(0,1,"Call PROGRESSING timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.TIMEOUT),this.hangup())}.bind(this),TIMEOUT_CALLPROGRESSING),setTimeout(function(){this.callState==CallState.PROGRESSING&&(this.sinch.log(new Notification(0,1,"Call ESTABLISHED timeout. Will hangup call.",this)),this.setEndCause(CallEndCause.NO_ANSWER),this.hangup())}.bind(this),TIMEOUT_CALLESTABLISHED);var i=JSON.parse(e.decrypted.nvps.sdp);i.sdp=this.updateSdp(i.sdp),this.sinch.log(new Notification(0,1,"Received SDP offer from B",i));var n=new SessionDescription(i),r=this.initPC();return this.pcMap[e.getSenderId()]=r,this.pc=r,r.setRemoteDescription(n,function(){for(this.sinch.log(new Notification(1,3,"Successfully configured SDP Offer.",i));(this.iceMapRx[this.activeInstance]||[]).length;){var t=this.iceMapRx[this.activeInstance].pop();this.injectIce(e.getSenderId(),t),this.sinch.log(new Notification(0,1,"Injected ice from Ice Rx buffert",t))}r.createAnswer(function(t){r.setLocalDescription(t,function(){if(this.sinch.log(new Notification(2,3,"Successfully created SDP Answer.",t)),this.progress(!1),"yes"==e.decrypted.nvps.p2p)this.sinch.log(new Notification(2,3,"Header detected, p2p, will proceed with direct peer connection!.",e)),this.sinch.mxp.sendSdpAnswer(this,t).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending SDP Answer")});else{this.disableIce=!0,this.sinch.log(new Notification(2,3,"p2p header not detected, will fall back on proxy, we might deal with an old client",e)),this.mediaObj={callid:this.callId,proxyid:e.decrypted.bd.split("/")[2],sdp:t},this.sinch.mxp.sendSdpAnswer(this);var i=e.decrypted.bd.split("/")[3].split(":");r.proxyIce=r.proxyIce||[],r.proxyIce.push(new IceCandidate({sdpMid:"audio",sdpMLI:0,sdpMLineIndex:0,candidate:CallHelper.generateIceCandidate(i[0],i[1])}))}}.bind(this),function(e){console.error("Major error in setting local description",e)})}.bind(this),function(e){console.error("Major error in creating answer",e)})}.bind(this),function(e){throw setTimeout(function(){this.setEndCause(CallEndCause.FAILURE),this.error=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,e),this.sinch.mxp.callCancel(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error setting remote SDP")}.bind(this)),t.promise},Call.prototype.answer=function(){if(this.sinch.log(new Notification(0,1,"Answer call initiated, to answer()",this)),this.callState==CallState.PROGRESSING)this.mediaObj?this.sinch.postMedia(this.mediaObj).then(function(e){var t="audio:ISAC/0.0.0.0/"+e.proxyid+"/"+e.ip+":"+e.port;this.sinch.mxp.joinIncomingCall(this,t).then(function(){this.sinch.log(new Notification(3,3,"Successfully sent updated proxy information in Ack to caller",t))}.bind(this)).fail(function(e){throw console.error(e),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Could not send Ack to Old with MEDIA answer")})}.bind(this)).fail(function(e){throw console.error(e),new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Could not send Answer to v1/media")}):this.sinch.mxp.joinIncomingCall(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending JOIN (pickup phone).")});else if("undefined"==typeof outgoingStream)this.sinch.log(new Notification(0,1,"Outgoing stream undefined, perhaps early answer. Will set auto answer for future automatic answer.")),this.autoAnswer=!0;else{if(this.callState==CallState.ENDED||this.callState==CallState.ESTABLISHED)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call in invalid state to answer.");this.sinch.log(new Notification(0,1,"Stream defined and state in initializing or progressing. Setting auto answer for later retry.")),this.autoAnswer=!0}},Call.prototype.openDataChannel=function(e){return void 0===this.dataChannels[e]&&(this.dataChannels[e]=this.pcMap[this.activeInstance].createDataChannel(e,{reliable:!1}),this.dataChannels[e].addEventListener=this.addEventListenerPrototype.bind(this.dataChannels[e]),this.execListener("onDataChannelAdded",this.dataChannels[e])),this.dataChannels[e]},Call.prototype.hangup=function(){if(this.hangupRetries=(this.hangupRetries||0)+1,this.callState==CallState.ESTABLISHED)this.sinch.mxp.callHangup(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Hangup")}),this.mxpHangup();else if(!this.callOutbound||this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)if(this.callOutbound||this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING){if(this.callState==CallState.ENDED)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call already ended");this.mxpHangup()}else this.callState==CallState.PROGRESSING?(this.sinch.mxp.callDeny(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Deny")}),this.setEndCause(CallEndCause.DENIED),this.mxpHangup()):this.autoHangup=!0;else Object.keys(this.clientMap).length>0||this.hangupRetries>5?(this.sinch.mxp.callCancel(this).fail(function(e){throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error sending call Cancel")}),this.mxpHangup()):(this.sinch.log(new Notification(0,1,"Can not hang up call at this time. Will try again in 0.5 seconds (max five retries).")),setTimeout(this.hangup.bind(this),500))},Call.prototype.getCallId=function(){return this.callId},Call.prototype.getDetails=function(){return new CallDetails({endCause:this.callEndCause,endedTime:this.timeEnded,error:this.error,establishedTime:this.timeEstablished,startedTime:this.timeProgressing,duration:this.timeEstablished?(this.timeEnded-this.timeEstablished)/1e3:0})},Call.prototype.getDirection=function(){return this.callOutbound?1:0},Call.prototype.getRemoteUserId=function(){return this.getDirection()?this.toId:this.fromId},Call.prototype.getState=function(){return Object.keys(CallState).filter(function(e){return CallState[e]===this.callState}.bind(this))[0]},Call.prototype.getEndCause=function(){return Object.keys(CallEndCause).filter(function(e){return CallEndCause[e]===this.callEndCause}.bind(this))[0]},Call.prototype.getHeaders=function(){return this.customHeaders},Call.prototype.sendDTMF=function(e){return this.DTMFsender||(this.DTMFsender=this.pc.createDTMFSender(this.outgoingStream.getAudioTracks()[0])),this.DTMFsender&&this.DTMFsender.insertDTMF(e)},Call.prototype.mute=function(){if(this.callState!=CallState.ESTABLISHED&&this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call not in ESTABLISHED state.");this.sinch.log(new Notification(0,1,"Call was muted using mute()."));for(var e=this.outgoingStream.getAudioTracks(),t=0;t<e.length;t++)e[t].enabled=!1},Call.prototype.unmute=function(){if(this.callState!=CallState.ESTABLISHED&&this.callState!=CallState.PROGRESSING&&this.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Call not in ESTABLISHED state.");this.sinch.log(new Notification(0,1,"Call was un-muted using unmute()."));for(var e=this.outgoingStream.getAudioTracks(),t=0;t<e.length;t++)e[t].enabled=!0},navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia=navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia),CallClient.prototype.addEventListener=function(e){this.eventListeners.push(e)},CallClient.prototype.removeEventListener=function(e){this.eventListeners.splice(this.eventListeners.indexOf(e),1)},CallClient.prototype.execListener=function(e,t){var i=0;return this.eventListeners.forEach(function(n){return i++,n[e]&&n[e](t)}.bind(this)),i},CallClient.prototype.initStream=function(e,t){var i=Q.defer(),n=!(!this.sinch._supportVideo||t)&&{mandatory:{maxWidth:320,maxHeight:240}};return void 0!==e?(this.sinch.log(new Notification(0,1,"Will wire customStream into call",e)),i.resolve(e)):void 0===this.localMediaStream?(this.sinch.log(new Notification(0,1,"Will retrieve new Mic for stream")),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia({video:n,audio:!0}).then(function(e){this.localMediaStream=e,i.resolve(this.localMediaStream)}).catch(function(e){console.error("Error retrieving media stream",e)})):(this.sinch.log(new Notification(0,1,"Will retrieve cached Mic for stream",this.localMediaStream)),i.resolve(this.localMediaStream)),i.promise},CallClient.prototype.alreadyInCall=function(){if(this.sinch._multiCall)return!1;for(var e in this.callBuffert)if(this.callBuffert[e].callState==CallState.PROGRESSING||this.callBuffert[e].callState==CallState.ESTABLISHED)return!0},CallClient.prototype.handleIncomingCall=function(e){this.sinch.log(new Notification(0,1,"Will handle incoming call",e));var t,i=new Call(this.sinch,this.sinch._supportVideo,e.mxpSessionId);(e.decrypted.nvps||{}).nomedia?i.callDomain="connection":i.callDomain="data",i.setParticipants(e.decrypted.fu,this.sinch.user.userId),i.customHeaders=JSON.parse((e.decrypted.nvps||{}).ph||"{}"),this.sinch.mxp.configureMxpSession(i.callId,e.decrypted.nvps.key,e.decrypted.bd),i.clientMap[e.getSenderId()]=e.getFrom(),this.callBuffert[i.callId]=i,this.alreadyInCall()?(this.sinch.log(new Notification(0,1,"Already in a call, will hangup incoming call.",e)),this.sinch.mxp.subscribe("signalPubNub").then(function(){this.sinch.mxp.callDeny(i)}.bind(this))):this.execListener("onIncomingCall",i)?("connection"==i.callDomain?(t=Q.defer(),t.resolve(null),t.promise):this.initStream(this.incomingCallCustomStream)).then(function(t){return this.execListener("onMediaStream",t),this.sinch.mxp.subscribe("signalPubNub").then(function(){(e.decrypted.nvps||{}).nomedia||i.setStream(t),i.activeInstance=e.getSenderId(),i.proxyUrl=e.decrypted.bd.replace(/(\r\n|\n|\r)/gm,""),i.ackIncomingCall(e).catch(function(e){console.error("Error handling incoming call",e)})}.bind(this))}.bind(this)):this.sinch.log(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingCallback,"Missing handler, onIncomingCall."))},CallClient.prototype.callUser=function(e,t,i){this.sinch.log(new Notification(0,1,"CallUser method called",e));var n=new Call(this.sinch,this.sinch._supportVideo);return n.customHeaders=t,this.initStream(i).then(function(t){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(n.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");n.setStream(t),n.placeCall(e,"data"),this.callBuffert[n.callId]=n}.bind(this))}.bind(this)),n},CallClient.prototype.callSip=function(e,t,i){this.sinch.log(new Notification(0,1,"CallSip method called",e));var n=new Call(this.sinch);return n.customHeaders=t,this.initStream(i).then(function(t){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(n.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");n.setStream(t),n.placeCall(e,"sip"),this.callBuffert[n.callId]=n}.bind(this))}.bind(this)),n},CallClient.prototype.connect=function(e,t){this.sinch.log(new Notification(0,1,"connect method called",e));var i=new Call(this.sinch);return i.customHeaders=t,this.sinch.mxp.subscribe("signalPubNub").then(function(){if(i.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing connect. Incorrect call state.");i.placeCall(e,"connection"),this.callBuffert[i.callId]=i}.bind(this)),i},CallClient.prototype.callPhoneNumber=function(e,t,i){this.sinch.log(new Notification(0,1,"CallPhoneNumber method called",e));var n=new Call(this.sinch);return n.customHeaders=t,this.initStream(i,!0).then(function(t){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(n.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");n.setStream(t),n.placeCall(e,"pstn"),this.callBuffert[n.callId]=n}.bind(this))}.bind(this)),n},CallClient.prototype.callConference=function(e,t,i){if(this.sinch.log(new Notification(0,1,"CallConference method called",e)),!(e=""+e)||e.length>64)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Invalid conferenceId. Must be alphanumeric string less than 64 characters in length.");var n=new Call(this.sinch);return n.customHeaders=t,this.initStream(i,!0).then(function(t){return this.sinch.mxp.subscribe("signalPubNub").then(function(){if(n.callState!=CallState.INITIATING)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Error executing user call. Incorrect call state.");n.setStream(t),n.placeCall(e,"conference"),this.callBuffert[n.callId]=n}.bind(this))}.bind(this)),n},CallClient.prototype.callGroup=function(e){if(this.sinch.log(new Notification(0,1,"callRoom method called, for group",e)),void 0!==this.groupChannel)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not call room, already in a room");if(!this.sinch._multiCall)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not call room, multiCall capability not specified");return this.groupChannel=e,new GroupCall(this.sinch,e)};var CallState={INITIATING:0,PROGRESSING:1,ESTABLISHED:2,ENDED:3,TRANSFERRING:4},CallEndCause={NONE:0,TIMEOUT:1,CANCELED:6,DENIED:2,FAILURE:4,HUNG_UP:5,NO_ANSWER:3,OTHER_DEVICE_ANSWERED:7,TIMEOUT:1,TRANSFERRED:8},TIMEOUT_CALLPROGRESSING=10500,TIMEOUT_CALLESTABLISHED=45e3,CallHelper=function(){};function CalloutVerification(e,t,i){if(!(e instanceof Sinch))throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. VerificationClient can not be instantiated, use createSmsVerification in an SinchClient instance",error);if(void 0===t||0==t.toString().length)throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. Valid phone number required (E.164 format ideally)",t);this.sinch=e,this.number=t||null,this.custom=i||null,this.flagVerified=!1}function FlashCallVerification(e,t,i){if(!(e instanceof Sinch))throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. VerificationClient can not be instantiated, use createSmsVerification in an SinchClient instance",error);if(void 0===t||0==t.toString().length)throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. Valid phone number required (E.164 format ideally)",t);this.sinch=e,this.number=t||null,this.custom=i||null,this.flagVerified=!1}function GroupCall(e,t){this.sinch=e,this.callClient=e.callClient,this.groupChannel=t,this.eventListeners=[],this.callBuffert=[],this.callListeners={onCallProgressing:function(e){this.sinch.log(new Notification(0,1,"Call progressing",e))}.bind(this),onCallEstablished:function(e){this.sinch.log(new Notification(0,1,"Call established",e)),this.execListener("onGroupRemoteCallAdded",e)}.bind(this),onCallEnded:function(e){this.sinch.log(new Notification(0,1,"Call ended",e)),this.execListener("onGroupRemoteCallRemoved",e)}.bind(this)},this.groupListener={onIncomingCall:function(e){e.addEventListener(this.callListeners),setTimeout(function(){e.answer()},450*Object.keys(this.callBuffert).length+Math.random())}.bind(this)},this.callClient.addEventListener(this.groupListener),this.sinch.callClient.initStream().then(function(e){this.sinch.log(new Notification(0,1,"Media stream successfully created",e)),this.execListener("onGroupLocalMediaAdded",e),this.sinch.mxp.broadcastPubNub.publish({channel:t,message:this.sinch.user.userId}),this.sinch.mxp.subscribeNotificationChannel(t)}.bind(this)),this.sinch.onnotification=function(e,i){t==e&&i!=this.sinch.user.userId&&(this.sinch.log(new Notification(0,1,"Will call user in group, after random timeout",i)),setTimeout(function(){var e=this.callClient.callUser(i);this.callBuffert.push(e),e.addEventListener(this.callListeners)}.bind(this),300+Math.round(500*Math.random())))}.bind(this)}function Message(e,t){if(this.delivered=[],this.direction=!t,e instanceof MXPMessageObj){this.messageId=e.mxpSessionId;var i=JSON.parse(e.decrypted.bd);this.textBody=i.t,this.recipientIds=e.recipientIds,this.senderId=e.decrypted.fu;try{this.headers=e.decrypted.nvps.ph}catch(e){}this.timestamp=new Date}else{if(!(e instanceof Object))throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Unsupported message parameters",e);this.messageId=getUuid(),this.recipientIds=e.recipientIds,this.textBody=e.textBody,this.senderId=e.senderId,this.headers=e.publicHeaders,this.timestamp=new Date}}function MessageDeliveryInfo(e,t){this.messageId=t,this.recipientId=e,this.timestamp=new Date}function MessageClient(e){if(!(e instanceof Sinch))throw new Error("MessageClient can't be instantiated, use getMessageClient in an SinchClient instance");this.sinch=e,this.eventListeners=[],this.messageBuffert={},this.ackBuffert={},this.onMessageDelivered=[],this.emptyLog(),this.messageLogInterval=setInterval(this.commitLog.bind(this),3e4)}function SinchError(e,t,i,n){this.name="SinchError",this.domain=e||-1,this.code=t||0,this.response=n||{},this.message=i||"General sinch error",this.stack=new Error(i).stack}function User(e){this.userObj={},this.sinch=e}function Verification(e,t,i,n){if(!(e instanceof Sinch))throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. VerificationClient can not be instantiated, use createSmsVerification in an SinchClient instance",error);if(void 0===t||0==t.toString().length)throw new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationInvalidInput,"Invalid input to constructor. Valid phone number required (E.164 format ideally)",t);this.method=n||"sms",this.sinch=e,this.number=t||null,this.custom=i||null,this.flagVerified=!1}CallHelper.generateIceCandidate=function(e,t){return"candidate:"+(""+Math.random()).substring(2,7)+" 1 UDP 2130706431 "+e+" "+t+" typ relay raddr 0.0.0.0 rport 0 generation 0\r\n"},CalloutVerification.prototype.initiate=function(e,t){var i=Q.defer();if(this.flagVerified){var n=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationUnexpectedInitiateError,"Verification already verified, can't perform another callout.");i.reject(n)}else{var r={identity:{type:"number",endpoint:this.number},custom:this.custom,method:"callout",metadata:{os:getBrowserInfo(),platform:getPlatformInfo(),sdk:"js/"+this.sinch.getVersion()}};this.sinch.log(new Notification(0,1,"Will initiate callout verification using object",r)),this.sinch.confirmUserCallout(r).then(function(n){var r=this;r.sinch.log(new Notification(0,1,"Successfully initiated callout verification with response",n));var s=0,o=function(){r.sinch.queryVerificationById({number:r.number}).then(function(a){switch(r.sinch.log(new Notification(0,1,"Poll result after "+s+"s",a)),a.status){case"SUCCESSFUL":r.sinch.log(new Notification(0,1,"Successfully verified number after "+s+"s")),e&&e(),i.resolve();break;case"PENDING":if(s+=n.callout.pollingInterval,n.callout.pollingInterval>0&&s<n.callout.stopPollingAfter)window.setTimeout(o,1e3*n.callout.pollingInterval);else{var c=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationIncorrectCode,"Verification Failed, Timeout");t&&t(c),i.reject(c)}break;case"FAIL":case"ERROR":r.sinch.log(new Notification(0,1,"Verification failed after "+s+"s"));c=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationIncorrectCode,"Verification Failed, "+a.reason);t&&t(c),i.reject(c);break;default:r.sinch.log(new Notification(0,1,"Server response not handled at "+s+"s",a))}}).fail(function(e){var n;n=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationServiceError,"Could not poll verification status: "+e.statusText,e.responseText):e,this.sinch.log(n),t&&t(n),i.reject(n)})};window.setTimeout(o,1e3*n.callout.startPollingAfter)}.bind(this)).fail(function(e){var n;n=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationServiceError,"Could not request verification: "+e.statusText,e.responseText):e,this.sinch.log(n),t&&t(n),i.reject(n)}.bind(this))}return i.promise},FlashCallVerification.prototype.initiate=function(e,t){var i=Q.defer();if(this.flagVerified){var n=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationUnexpectedInitiateError,"Verification already verified, can't perform another callout.");i.reject(n)}else{var r={identity:{type:"number",endpoint:this.number},custom:this.custom,method:"flashcall",metadata:{os:getBrowserInfo(),platform:getPlatformInfo(),sdk:"js/"+this.sinch.getVersion()}};this.sinch.log(new Notification(0,1,"Will initiate flashcall verification using object: ",r)),this.sinch.confirmUserCallout(r).then(function(t){this.sinch.log(new Notification(0,1,"Successfully initiated callout verification with response",t)),e&&e(),i.resolve()}.bind(this)).fail(function(e){var n;n=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationServiceError,"Could not request verification: "+e.statusText,e.responseText):e,this.sinch.log(n),t&&t(n),i.reject(n)}.bind(this))}return i.promise},FlashCallVerification.prototype.verify=function(e,t,i){var n=Q.defer();if(this.flagVerified)t&&t(this.cachedResponse),n.resolve(this.cachedResponse);else{var r={number:this.number,source:"manual",flashcall:{cli:e},method:"flashcall"};this.sinch.confirmUserSMS(r).then(function(e){this.flagVerified=!0,this.cachedResponse=e,t&&t(e),n.resolve(e)}.bind(this)).fail(function(e){var t;t=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationIncorrectCode,"Could not verify code: "+e.statusText,e.responseText):e,i&&i(t),n.reject(t)}.bind(this))}return n.promise},GroupCall.prototype.addEventListener=function(e){this.eventListeners.push(e)},GroupCall.prototype.removeEventListener=function(e){this.eventListeners.splice(this.eventListeners.indexOf(e),1)},GroupCall.prototype.execListener=function(e,t){var i=0;return this.eventListeners.forEach(function(n){return i++,n[e]&&n[e](t)}.bind(this)),i},GroupCall.prototype.hangupGroup=function(){if(void 0===this.callClient.groupChannel)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalOther,"Can not leave room, not in a room");for(var e in this.callBuffert)this.callBuffert[e].hangup();this.callClient.removeEventListener(this.groupListener),this.callClient.groupChannel=void 0},Message.prototype.getMXPMessageObj=function(){var e=new MXPMessageObj;return e.mxpSessionId=this.messageId,e.decrypted={bd:JSON.stringify({t:this.textBody})},this.headers&&(e.decrypted.nvps={ph:this.headers}),e.recipientIds=this.recipientIds,e},MessageClient.prototype.emptyLog=function(){this.logCounters={version:"2.0",sent:0,received:0,failed:0}},MessageClient.prototype.commitLog=function(){(this.logCounters.sent||this.logCounters.received||this.logCounters.failed)&&(this.sinch.log(new Notification(0,1,"Will post IM log to backend for statistics",this.logCounters)),this.sinch.messageReporting(this.logCounters).then(this.emptyLog.bind(this)))},MessageClient.prototype.destroy=function(){this.commitLog(),clearInterval(this.messageLogInterval)},MessageClient.prototype.handleMessage=function(e){var t;e.recipientIds=e.transportObj.participants.reduce(function(e,t){return e.push(t.destination.identity),e}.bind(this),[]);var i=!1;return this.messageBuffert[e.mxpSessionId]?t=this.messageBuffert[e.mxpSessionId]:(t=new Message(e,e.decrypted.fu!=this.sinch.user.userId),this.messageBuffert[t.messageId]=t,i=!0),!t.passedToHandler&&(this.eventListeners.forEach(function(e){return t.passedToHandler=!0,e.onIncomingMessage&&e.onIncomingMessage(t)}),i&&this.ackBuffert[t.messageId]&&(this.ackBuffert[t.messageId].forEach(function(e){this.ackMsg(e,t.messageId)}.bind(this)),delete this.ackBuffert[t.messageId]),t.direction||this.logCounters.received++,!0)},MessageClient.prototype.addEventListener=function(e){this.eventListeners.push(e)},MessageClient.prototype.removeEventListener=function(e){this.eventListeners.splice(this.eventListeners.indexOf(e),1)},MessageClient.prototype.send=function(e,t,i){var n=Q.defer();if(this.sinch.log(new Notification(0,1,"Send message method called"),n),!(e instanceof Message))throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Unsupported message parameters",e);return t=t||function(e){return e},i=i||function(e){console.error(e)},Q.fcall(function(e){if(void 0===this.sinch.mxp){var t=new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Sinch is not ready yet");throw n.reject(t),t}if(e.sent)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Message already sent");return e.sent=!0,e}.bind(this),e).then(this.sinch.mxp.sendMessage.bind(this.sinch.mxp)).then(t).then(function(){this.logCounters.sent++}.bind(this)).then(n.resolve).fail(function(e){this.sinch.log(e),i(e),this.logCounters.failed++,n.reject(e)}.bind(this)).progress(function(e){this.sinch.log(e),n.notify(e)}.bind(this)),n.promise},MessageClient.prototype.ackMsg=function(e,t){this.messageBuffert[t]&&-1===this.messageBuffert[t].delivered.indexOf(e)?(this.sinch.log(new MXPLog("Recieved ack from "+e+" for message",t)),this.messageBuffert[t].delivered.push(e),this.eventListeners.forEach(function(i){return i.onMessageDelivered&&i.onMessageDelivered(new MessageDeliveryInfo(e,t))}.bind(this))):(this.ackBuffert[t]||(this.ackBuffert[t]=[]),this.ackBuffert[t].push(e),this.sinch.log(new MXPLog("Got ack for message with non-existing messageId, storing in ackBuffert",t)))},MessageClient.prototype.newMessage=function(e,t,i){if("string"==typeof e&&(e=[e]),"string"!=typeof t)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Message text must be a string (for cross device compatability). Please stringify any objects.");if(i&&"string"!=typeof i)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKUnexpectedCall,"Headers must be a string (for cross device compatability). Please stringify any objects.");return new Message({recipientIds:e,textBody:t,senderId:this.sinch.user.userId,publicHeaders:i})},SinchError.prototype=Error.prototype,User.prototype.updateUser=function(e){var t=Q.defer();return this.sinch.updateUser(e).then(function(e){this.userObj=e,t.resolve(e)}.bind(this)).fail(function(e){t.reject(e)}.bind(this)),t.promise},User.prototype.create=function(e){var t=Q.defer(),i={password:e.password,identities:[]};return e.email&&(i.profile={contact:{email:e.email}},i.identities.push({type:"email",endpoint:e.email})),e.username&&i.identities.push({type:"username",endpoint:e.username}),e.number&&i.identities.push({type:"number",endpoint:e.number}),this.sinch.createUser(i).then(function(e){this.userObj=e,this.userId=e.user.identities.reduce(function(e,t){return"username"===t.type?t.endpoint:e+""},""),t.resolve(e)}.bind(this)).fail(function(e){t.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,e.data.errorCode+" "+e.data.message,e.data))}),t.promise},User.prototype.authenticate=function(e){if("object"!=typeof e)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,'No valid identity or authentication ticket. If you are passing your own authentication tickets, ensure it is an object on the format {"userTicket":SOME_TICKET}',e);if(e.expiresIn=e.expiresIn||86400,e.sessionId&&e.sessionSecret)return e;var t=Q.defer(),i="";if(this.sinch._appSecret)e=SinchTicketGenerator(this.sinch._appKey,this.sinch._appSecret,e);else if("email"in e){if(i=this.sinch.authenticate,""==e.email)return t.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Email is empty",e)),t.promise}else if("username"in e){if(i=this.sinch.authenticateUsername,""==e.username)return t.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Username is empty",e)),t.promise}else if("number"in e&&(i=this.sinch.authenticateNumber,""==e.number))return t.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Number is empty",e)),t.promise;if(e.authorization||e.userTicket){if(e.userTicket&&!e.user){var n=e.userTicket.split(":"),r=JSON.parse(atob(n[0]));"username"===!r.identity.type&&t.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"Username missing in userTicket JSON object.",e)),e.user={identities:[r.identity]}}this.userObj=e,this.userObj.authorization=e.authorization||e.userTicket,this.userId=e.user.identities.reduce(function(e,t){return"username"===t.type?t.endpoint:e+""},""),t.resolve()}else i?i(e).then(function(e){this.userObj=e,this.userId=e.user.identities.reduce(function(e,t){return"username"===t.type?t.endpoint:e+""},""),t.resolve()}.bind(this)).fail(function(e){t.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,e.data.errorCode+" "+e.data.message,e.data))}):t.reject(new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKMissingParameter,"No valid identity or authentication ticket",e));return t.promise},User.prototype.initSessKeySecret=function(){var e=Q.defer(),t={};t.version={os:getBrowserInfo()||"unknown",platform:getPlatformInfo()||"unknown",sdk:"js/"+this.sinch.getVersion()},t.services={calling:[]},this.sinch._onlineCapability&&t.services.calling.push("online"),this.sinch.capabilities.messaging&&t.services.calling.push("im"),this.sinch.capabilities.calling&&(t.services.calling.push("voip"),t.services.calling.push("p2p"),t.services.calling.push("srtp")),t.authorization=this.userObj.authorization;var i=""!==this.sinch._sessionId;return i&&(t.instanceId=this.sinch._sessionId),t.expiresIn=31536e3,this.sinch[i?"renewSecret":"getInstance"](t).then(function(t){this.sinch.config({sessionId:t.id,sessionSecret:t.secret}),e.resolve()}.bind(this)).fail(function(t){this.sinch._sessionId="",this.sinch._sessionSecret="",e.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,t.data.errorCode+" "+t.data.message,t.data))}.bind(this)),e.promise},User.prototype.resumeSession=function(e){var t=Q.defer();return this.userId=e.userId,this.sinch.config(e),this.sinch.getUserProfile().then(function(e){this.userObj=e,t.resolve()}.bind(this)).fail(function(e){e instanceof SinchError?t.reject(e):t.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,e.data.errorCode+" "+e.data.message,e.data))}),t.promise},User.prototype.getMXPConf=function(){var e=Q.defer();return this.sinch.getConfiguration().then(function(t){this.mxpConfig=t,e.resolve()}.bind(this)).fail(function(t){e.reject(new SinchError(ErrorDomain.ErrorDomainApi,ErrorCode.ApiApiCallFailed,t.data.errorCode+" "+t.data.message,t.data))}),e.promise},Verification.prototype.request=function(e,t){var i=Q.defer();if(this.flagVerified){var n=new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationUnexpectedInitiateError,"Verification already verified, can't request new code.");i.reject(n)}else{var r={identity:{type:"number",endpoint:this.number},custom:this.custom,method:this.method,metadata:{os:getBrowserInfo(),platform:getPlatformInfo(),sdk:"js/"+this.sinch.getVersion()}};this.sinch.verify(r).then(function(t){e&&e(),i.resolve()}.bind(this)).fail(function(e){var n;n=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationServiceError,"Could not request verification: "+e.statusText,e.responseText):e,t&&t(n),i.reject(n)}.bind(this))}return i.promise},Verification.prototype.verify=function(e,t,i){var n=Q.defer();if(this.flagVerified)t&&t(this.cachedResponse),n.resolve(this.cachedResponse);else{var r={number:this.number,source:"manual",sms:"sms"==this.method?{code:e}:null,flashcall:"flashcall"==this.method?{cli:e}:null,method:this.method||"sms"};this.sinch.confirmVerification(r).then(function(e){this.flagVerified=!0,this.cachedResponse=e,t&&t(e),n.resolve(e)}.bind(this)).fail(function(e){var t;t=e.status?new SinchError(ErrorDomain.ErrorDomainVerification,ErrorCode.VerificationIncorrectCode,"Could not verify code: "+e.statusText,e.responseText):e,i&&i(t),n.reject(t)}.bind(this))}return n.promise},Verification.prototype.initiate=function(e,t){return this.request(e,t)},Verification.prototype.retry=function(e,t){return this.request(e,t)};var MXPencrypt=function(e){var t=e.key,i=e.decrypted;e.mxpSessionId;try{var n=CryptoJS.enc.Utf8.parse(JSON.stringify(i));t=CryptoJS.enc.Base64.parse(t);var r=CryptoJS.lib.WordArray.random(16),s=CryptoJS.AES.encrypt(n,t,{iv:r}),o=CryptoJS.enc.Hex.parse(r.toString(CryptoJS.enc.Hex)+s.ciphertext.toString(CryptoJS.enc.Hex))}catch(t){throw t.message=e.message,new MXPCryptError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"MXPEncrypt error: "+t.message,t)}return e.encrypted=o.toString(CryptoJS.enc.Base64),e},MXPdecrypt=function(e){try{var t=e.key,i=e.message.split(" ")[5],n=CryptoJS.enc.Base64.parse(i).toString(CryptoJS.enc.Hex),r=CryptoJS.enc.Hex.parse(n.substr(0,32)),s=CryptoJS.enc.Hex.parse(n.substr(32)),o=CryptoJS.lib.CipherParams.create({ciphertext:s,salt:null}),a=CryptoJS.AES.decrypt(o,CryptoJS.enc.Base64.parse(t),{iv:r}).toString(CryptoJS.enc.Utf8),c=a.indexOf("{"),l=a.lastIndexOf("}")+1;a=a.substring(c,l),e.decrypted=JSON.parse(a)}catch(t){throw t.message=e.message,new MXPCryptError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"MXPDecrypt error: "+t.message,t)}return e};function MXPCryptError(e,t,i,n){this.name="MXPError",this.domain=e||-1,this.code=t||0,this.response=n||{},this.message=i||"General MXP error",this.stack=new Error(i).stack}function MXPMessageObj(e,t,i){this.decrypted={};for(var n in e)if("object"==typeof e[n]){e[n]instanceof Array?this[n]=[]:this[n]={};for(var r in e[n])this[n][r]=e[n][r]}else this[n]=e[n];if(t instanceof Call){t.activeInstance&&i&&(this.decrypted.nvps=this.decrypted.nvps||{},this.decrypted.nvps.to=t.activeInstance),this.txChannels=[];for(var s in t.clientMap)"virtual"!=s&&-1===this.txChannels.indexOf(t.clientMap[s].fs)&&this.txChannels.push(t.clientMap[s].fs);0==this.txChannels.length&&"virtual"in t.clientMap&&this.txChannels.push(t.clientMap.virtual.fs),this.sub="signalPubNub"}}function MXP(e){this.sinch=e,this.user=e.user,this.rtcConfiguration=e.user.mxpConfig.rtcConfiguration,this.rtcProfile=e.user.mxpConfig.rtcProfile,this.broadcastPubNub=PUBNUB({publish_key:this.rtcConfiguration.broadcastNetwork.publishKey,subscribe_key:this.rtcConfiguration.broadcastNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.broadcastNetwork.host}),this.signalPubNub=PUBNUB({publish_key:this.rtcConfiguration.signalNetwork.publishKey,subscribe_key:this.rtcConfiguration.signalNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.signalNetwork.host}),this.messageBuffert={},this.transportBuffert={},this.sessionBuffert={},this.unencryptedFrames={},this.broadcastPubNub.sinchStack={},this.broadcastPubNub.sinchStack[this.rtcProfile.broadcastChannel]=[],this.broadcastPubNub.sinchStack[this.rtcProfile.transportChannel]=[],this.signalPubNub.sinchStack={},this.signalPubNub.sinchStack[this.rtcProfile.signalChannel]=[]}function MXPError(e,t,i,n){this.name="MXPError",this.domain=e||-1,this.code=t||0,this.response=n||{},this.message=i||"General MXP error",this.stack=new Error(i).stack}function MXPLog(e,t){this.message=e,this.object=t}function MXPIncoming(e,t){this.handler=e,this.object=t}function MXPOutgoing(e,t){this.handler=e,this.object=t}MXPMessageObj.prototype.getSenderId=function(){if(void 0===this.decrypted.fi)throw new SinchError(ErrorDomain.ErrorDomainSDK,ErrorCode.SDKInternalError,"getSenderId failed, no from instance defined",{});return this.decrypted.fsi?this.decrypted.fi+this.decrypted.fsi||"virtual":(this.decrypted.nvps||{}).fsi?this.decrypted.fi+this.decrypted.nvps.fsi||"virtual":this.decrypted.fi||"virtual"},MXPMessageObj.prototype.getFrom=function(){return{fc:this.decrypted.fc,fd:this.decrypted.fd,fi:this.decrypted.fi,fsi:this.decrypted.fsi,fs:this.decrypted.fs,fu:this.decrypted.fu}},MXPMessageObj.prototype.getInstanceId=function(){return this.decrypted.fi?this.decrypted.fi.split(":")[0]:null},MXP.prototype.init=function(){return this.subscribe("broadcastPubNub")},MXP.prototype.close=function(){var e=this.broadcastPubNub,t=this.signalPubNub;return setTimeout(function(){e&&e.offline(),t&&t.offline()}.bind(this),1e4),Q.all([this.unsubscribe("broadcastPubNub"),this.unsubscribe("signalPubNub")])},MXP.prototype.destroy=function(){delete this.broadcastPubNub,delete this.signalPubNub},MXP.prototype.subscribe=function(e){var t=Q.defer(),i={restore:!1,connect:function(e){t.resolve()}.bind(this),channel:Object.keys(this[e].sinchStack),callback:this._onmessagePubNub.bind(this),disconnect:this._ondisconnectPubNub.bind(this),error:this._onerrorPubNub.bind(this)},n=!0;for(var r in this[e].sinchStack)n&=0==this[e].sinchStack[r].length,this[e].sinchStack[r].push(!0);return n?this[e].subscribe(i):t.resolve(),t.promise},MXP.prototype.subscribeNotificationChannel=function(e){var t=Q.defer();this.broadcastPubNub.sinchStack[e]=[];var i={restore:!1,connect:function(e){t.resolve()}.bind(this),channel:e,callback:function(t){this.sinch.onnotification(e,t)}.bind(this),disconnect:this._ondisconnectPubNub.bind(this),error:this._onerrorPubNub.bind(this)};return this.broadcastPubNub.subscribe(i),t.promise},MXP.prototype.unsubscribe=function(e){var t=!0;for(var i in this[e].sinchStack)this[e].sinchStack[i].pop(),t&=0==this[e].sinchStack[i].length;t&&this[e].unsubscribe({channel:Object.keys(this[e].sinchStack)})},MXP.prototype.signalStatus=function(){return this.signalPubNub.sinchStack[this.rtcProfile.signalChannel].length>0},MXP.prototype._onmessagePubNub=function(e){this.sinch.log(new MXPLog("Recieved message",e)),Q.fcall(this.collectFrames.bind(this),e).then(this.identifyKey.bind(this)).then(MXPdecrypt).then(this.handleMessage.bind(this)).fail(function(t){if(t instanceof MXPCryptError){var i=e.split(" ")[1];this.unencryptedFrames[i]=this.unencryptedFrames[i]||[],this.unencryptedFrames[i].push(t.response.message)}else this.handleError(t)}.bind(this))},MXP.prototype.configureMxpSession=function(e,t,i){this.sessionBuffert[e]={key:t,body:i},this.processUnencryptedForKey(e)},MXP.prototype.processUnencryptedForKey=function(e){for(var t in this.unencryptedFrames[e])this._onmessagePubNub(this.unencryptedFrames[e][t]),delete this.unencryptedFrames[e][t]},MXP.prototype._ondisconnectPubNub=function(e){this.sinch.log(new MXPLog("Was disconnected!",e))},MXP.prototype._onerrorPubNub=function(e){var t=new MXPError(ErrorDomain.ErrorDomainNetwork,ErrorCode.NetworkConnectionRefused,"PubNub error",e);this.sinch.log(t)},MXP.prototype.collectFrames=function(e){var t=Q.defer(),i=e.split(" "),n=i[1]+i[2];try{i[3]=parseInt(i[3]),i[4]=parseInt(i[4])}catch(e){console.error("Could not parse MXP indices. Malformatted MXP message.")}if(1===i[4])t.resolve(e);else if((this.messageBuffert[n]||(this.messageBuffert[n]={}))[i[3]]=i[5],Object.keys(this.messageBuffert[n]).length==i[4]){var r=i[0]+" "+i[1]+" "+i[2]+" 0 1 ";for(var s in this.messageBuffert[n])r+=this.messageBuffert[n][s];void 0!==i[6]&&(r+=" "+i[6]),this.sinch.log(new MXPLog("All frames collected and merged, full array",this.messageBuffert[n])),delete this.messageBuffert[n],t.resolve(r)}else t.reject(new MXPLog("All frames not yet gathered",this.messageBuffert[n]));return t.promise},MXP.prototype.identifyKey=function(e){this.sinch.log(new MXPLog("Will identify key",e));var t,i=Q.defer(),n=e.trim().split(" ");return void 0!==(t=n[6])?(this.sinch.log(new MXPLog("Transport key identified",e)),this.getTransport(t).then(function(r){i.resolve(new MXPMessageObj({mxpSessionId:n[1],message:e,transportId:t,transportObj:r,key:this.transportBuffert[t].key,keyType:"T"}))}.bind(this)).fail(function(e){i.reject(e)}.bind(this))):void 0!==(this.sessionBuffert[n[1]]||{}).key?(this.sinch.log(new MXPLog("Session key in buffert identified",e)),i.resolve(new MXPMessageObj({mxpSessionId:n[1],message:e,key:this.sessionBuffert[n[1]].key,keyType:"S"}))):(this.sinch.log(new MXPLog("No key, fall back on instance key",e)),i.resolve(new MXPMessageObj({mxpSessionId:n[1],message:e,key:this.rtcProfile.key,keyType:"I"}))),i.promise},MXP.prototype.handleMessage=function(e){this.sinch.log(new MXPLog("Will handle message",e));var t=Q.defer(),i=e.decrypted.md+"_"+(e.decrypted.bt||"null");return this.sinch.logMxp(new MXPIncoming(i,e)),MXPHandlers[i]?MXPHandlers[i].call(this,e):t.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Handler not implemented: "+i,{})),t.promise},MXP.prototype.handleError=function(e){this.sinch.log(e),e.stack&&console.error(e.stack)},MXP.prototype.getTransport=function(e){var t=Q.defer();if(e.constructor==String){var i=e;void 0!==this.transportBuffert[i]?(this.sinch.log(new MXPLog("Got transport from Buffert",this.transportBuffert[i])),t.resolve(this.transportBuffert[i])):this.sinch.getTransportById({transportId:i}).then(function(e){this.sinch.log(new MXPLog("Got new transport",e)),this.transportBuffert[i]=e,t.resolve(this.transportBuffert[i])}.bind(this))}else{if(e instanceof MXPMessageObj||e instanceof Array){var n=e instanceof MXPMessageObj?e.recipientIds:e,r=(n=n.filter(function(e,t,i){return i.indexOf(e)===t})).indexOf(this.user.userId);r>-1&&n.splice(r,1);var s=[];n.forEach(function(e){if("string"==typeof e)s.push({identity:e});else if(e instanceof Object)for(var t in e)s.push({identity:e[t],type:t})}),n.push(this.user.userId),n=n.sort();var o=btoa(JSON.stringify(n));if(this.transportBuffert[o]){var a=this.transportBuffert[o];this.sinch.log(new MXPLog("Got cached transport for recipient(s)",a)),e instanceof MXPMessageObj?(e.transportObj=a,e.transportId=e.transportObj.transportId,t.resolve(e)):t.resolve(a)}else this.sinch.getTransportByParticipants(s).then(function(i){i.participants.forEach(function(e){e.capabilityUnion=[],(e.instances||[]).forEach(function(t){e.capabilityUnion=e.capabilityUnion.concat(t.capabilities)}),e.capabilityUnion=e.capabilityUnion.filter(function(t,i){return e.capabilityUnion.indexOf(t)==i})});var r=[];if(i.participants.forEach(function(e){-1===e.capabilityUnion.indexOf("im")&&-1===e.capabilityUnion.indexOf("im.1")&&r.push(e.destination.identity)}),r.length>0)throw new SinchError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"User missing capability",r);i.participants.unshift({channel:this.rtcProfile.transportChannel,destination:{identity:this.user.userId}});var s=i.participants.reduce(function(e,t){return e.push(t.destination.identity),e}.bind(this),[]),a=n.filter(function(e){return s.indexOf(e)<0});if(n.length!=i.participants.length)throw new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityUserNotFound,"User does not exist",a);this.sinch.log(new MXPLog("Got new transport for recipient(s)",i)),this.transportBuffert[o]=i,e instanceof MXPMessageObj?(e.transportObj=i,e.transportId=e.transportObj.transportId,t.resolve(e)):t.resolve(i)}.bind(this)).fail(function(e){t.reject(e)});return t.promise}t.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"Unknown transport ID",i))}return t.promise},MXP.prototype.sendMXP=function(e){var t=Q.defer();return e.sub=e.sub||"broadcastPubNub",Q.fcall(this.constructMXP.bind(this),e).then(this.identifyEnKey.bind(this)).then(MXPencrypt).then(this.splitFrames.bind(this)).then(this.getTxChannels.bind(this)).then(this.transmitFrames.bind(this)).then(function(e){t.resolve(e)}).fail(function(e){console.error(e.stack),console.error(e),t.reject(e)}).progress(function(e){t.notify(e)}),t.promise},MXP.prototype.constructMXP=function(e){return e.decrypted.fu=this.user.userId,e.decrypted.fi=this.sinch._sessionId+":"+this.sinch._subInstanceId,e.decrypted.fd=this.sinch._sessionId,e.decrypted.fc="",this.sinch.log(new MXPLog("Added meta data to MXP message",e)),e},MXP.prototype.identifyEnKey=function(e){return e.transportObj?(e.transportId=e.transportObj.transportId,e.key=e.transportObj.key,e.keyType="T",e.decrypted.fs=this.rtcProfile.transportChannel):(e.key=this.sessionBuffert[e.mxpSessionId].key,e.keyType="S",e.decrypted.fs=this.rtcProfile.signalChannel),this.sinch.log(new MXPLog("Identified Encoding Key",e)),e},MXP.prototype.splitFrames=function(e){e.encodedFrames=[];var t=1500;t-=e.mxpSessionId.length,t-=(e.transportId||"").length,t-=9,t-=6;do{e.encodedFrames.push(e.encrypted.slice(0,t)),e.encrypted=e.encrypted.substring(t)}while(e.encrypted.length>0);var i=Math.floor(2e9*Math.random());for(var n in e.encodedFrames)e.encodedFrames[n]="10 "+e.mxpSessionId+" "+(e.encodedFrames.length>1?i:"-")+" "+n+" "+e.encodedFrames.length+" "+e.encodedFrames[n],e.transportId&&(e.encodedFrames[n]+=" "+e.transportId);return this.sinch.log(new MXPLog("Split message into frames as needed",e)),e},MXP.prototype.getTxChannels=function(e){return e.txChannels=e.txChannels||[],e.transportObj&&e.transportObj.participants.forEach(function(t){e.txChannels.push(t.channel)}),this.sinch.log(new MXPLog("Identified Tx Channels",e)),e},MXP.prototype.transmitFrames=function(e){var t=Q.defer();this.sinch.logMxp(new MXPOutgoing(e.decrypted.md+"_"+(e.decrypted.bt||"null"),e));var i,n=[];return i=e.transportObj?e.transportObj.participants.length*e.encodedFrames.length:e.encodedFrames.length,n.length==i&&t.resolve(e),e.txChannels.forEach(function(r){e.encodedFrames.forEach(function(s){this.sinch.log(new MXPLog("Transmitting [channel, frame]",[r,s])),this[e.sub].publish({channel:r,message:s,callback:function(r){n.push(r),t.notify(new Notification(n.length,i,"MXP Message send progress (frame Tx)")),n.length==i&&setTimeout(function(){t.resolve(e)},1e3)},error:function(e){console.error("PubNub: Error sending frame",e),t.reject(new MXPError(ErrorDomain.ErrorDomainOther,ErrorCode.OtherOther,"PubNub: Error sending frame",e))}})}.bind(this))}.bind(this)),t.promise},MXPError.prototype=Error.prototype;var MXPCallingVersion=10;MXP.prototype.joinIncomingCall=function(e,t){var i=Q.defer(),n=new MXPMessageObj({mxpSessionId:e.callId},e,!0);return n.decrypted.bd=t||null,n.decrypted.md=3,n.decrypted.bt=t?"media":"sdp",n.decrypted.bv=MXPCallingVersion,this.sendMXP(n).then(function(){i.resolve()}).fail(function(e){i.reject(e)}).progress(function(e){i.notify(e)}.bind(this)),i.promise},MXP.prototype.callJoined=function(e){var t=Q.defer(),i=new MXPMessageObj({mxpSessionId:e.callId},e);return i.decrypted.bd=JSON.stringify(e.clientMap[e.activeInstance]),i.decrypted.md=4,i.decrypted.bt="client",i.decrypted.bv=MXPCallingVersion,i.decrypted.nvps&&delete i.decrypted.nvps.to,this.sendMXP(i).then(function(){t.resolve()}).fail(function(e){t.reject(e)}).progress(function(e){t.notify(e)}.bind(this)),t.promise},MXP.prototype.sendSdpAnswer=function(e,t){var i=Q.defer(),n=new MXPMessageObj({mxpSessionId:e.callId},e);return n.decrypted.bd=t?JSON.stringify(t):null,n.decrypted.md=2,n.decrypted.bt=t?"sdp":null,n.decrypted.bv=MXPCallingVersion,this.sendMXP(n).then(function(){i.resolve()}).fail(function(e){i.reject(e)}).progress(function(e){i.notify(e)}.bind(this)),i.promise},MXP.prototype.callHangup=function(e){var t=Q.defer(),i=new MXPMessageObj({mxpSessionId:e.callId},e);return i.decrypted.md=5,i.decrypted.bv=MXPCallingVersion,this.sendMXP(i).then(function(){t.resolve()}).fail(function(e){t.reject(e)}).progress(function(e){t.notify(e)}.bind(this)),t.promise},MXP.prototype.callDeny=function(e){var t=Q.defer(),i=new MXPMessageObj({mxpSessionId:e.callId},e);return i.decrypted.md=6,i.decrypted.bv=MXPCallingVersion,this.sendMXP(i).then(function(){t.resolve()}).fail(function(e){t.reject(e)}).progress(function(e){t.notify(e)}.bind(this)),t.promise},MXP.prototype.callCancel=function(e){var t=Q.defer(),i=new MXPMessageObj({mxpSessionId:e.callId},e);return i.decrypted.md=7,i.decrypted.bv=MXPCallingVersion,this.sendMXP(i).then(function(){t.resolve()}).fail(function(e){t.reject(e)}).progress(function(e){t.notify(e)}.bind(this)),t.promise},MXP.prototype.callTxICECandidate=function(e,t,i){var n=Q.defer(),r=new MXPMessageObj({mxpSessionId:e.callId},e);return r.decrypted.bd=JSON.stringify(t),r.decrypted.md=10,r.decrypted.bt="sdp",r.decrypted.bv=MXPCallingVersion,i&&(r.decrypted.nvps=r.decrypted.nvps||{},r.decrypted.nvps.to=i||"undefined"),this.sendMXP(r).then(function(){n.resolve()}).fail(function(e){n.reject(e)}).progress(function(e){n.notify(e)}.bind(this)),n.promise},MXP.prototype.callTxPeerEventSDP=function(e,t,i){var n=Q.defer(),r=new MXPMessageObj({mxpSessionId:e.callId},e);return r.decrypted.bd=JSON.stringify(t),r.decrypted.md=10,r.decrypted.bt="sdp",r.decrypted.bv=MXPCallingVersion,r.decrypted.nvps=r.decrypted.nvps||{},r.decrypted.nvps.to=i||"undefined",this.sendMXP(r).then(function(){n.resolve()}).fail(function(e){n.reject(e)}).progress(function(e){n.notify(e)}.bind(this)),n.promise},MXP.prototype.msgToMe=function(e){return!e.decrypted.nvps||!e.decrypted.nvps.to||e.decrypted.nvps.to==this.sinch._sessionId+":"+this.sinch._subInstanceId},MXP.prototype.msgToMe2=function(e){return!e.decrypted.nvps||!e.decrypted.nvps.to||e.decrypted.nvps.to==this.sinch._sessionId};var verifyCallingCapability=function(){if(void 0===this.sinch.callClient){var e=new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"Can not process call signal messages. Call capability not set.");this.sinch.log(e)}},MXPCallHandlers={"1_media":function(e){this.msgToMe2(e)?(verifyCallingCapability.call(this),this.sinch.callClient&&this.sinch.callClient.handleIncomingCall(e)):this.sinch.log(new Notification(0,1,"Received INVITE message not meant for this instance, nvps.to header set to foreign instance id",e))},"2_null":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpAck(e)},"2_media":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpAck(e)},"2_sdp":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpAck(e)},"3_media":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpJoin(e)},"3_sdp":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpJoin(e)},"4_client":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpJoined(e)},"5_null":function(e){this.msgToMe(e)?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpHangup(e):this.sinch.log(new Notification(0,1,"Received HUNG_UP message not meant for this instance, nvps.to header set to foreign instance id",e))},"6_null":function(e){this.msgToMe(e)?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpDeny(e):this.sinch.callClient&&this.sinch.log(new Notification(0,1,"Received DENIED message not meant for this instance, nvps.to header set to foreign instance id",e))},"6_error/json":function(e){this.msgToMe(e)?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpDeny(e):this.sinch.callClient&&this.sinch.log(new Notification(0,1,"Received DENIED message not meant for this instance, nvps.to header set to foreign instance id",e))},"7_null":function(e){this.msgToMe(e)?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpCancel(e):this.sinch.log(new Notification(0,1,"Received CANCEL message not meant for this instance, nvps.to header set to foreign instance id",e))},"7_client":function(e){this.msgToMe(e)?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpCancel(e):this.sinch.log(new Notification(0,1,"Received CANCEL message not meant for this instance, nvps.to header set to foreign instance id",e))},"9_message":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpFail(e)},"9_error/json":function(e){this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpFail(e)},"10_sdp":function(e){if(this.msgToMe(e)){var t=JSON.parse(e.decrypted.bd);"type"in t&&"offer"==t.type||"answer"==t.type?this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpPeerEventSdp(e):this.sinch.callClient&&this.sinch.callClient.callBuffert[e.mxpSessionId]&&this.sinch.callClient.callBuffert[e.mxpSessionId].mxpInjectIce(e)}else this.sinch.log(new Notification(0,1,"Received SDP/CAND message not meant for this instance, nvps.to header set to foreign instance id",e))}},MXPHandlers=MXPHandlers||{};for(var key in MXPCallHandlers)MXPHandlers[key]=MXPCallHandlers[key];var MXPMessagingVersion=10;MXP.prototype.sendMessage=function(e){var t=e.getMXPMessageObj(),i=Q.defer();return t.decrypted.md=1,t.decrypted.bt="msg",t.decrypted.bv=MXPMessagingVersion,this.getTransport(t).then(this.sendMXP.bind(this)).then(function(e){MXPHandlers["1_msg"].call(this,e),this.sinch.log(new MXPLog("Message sent to all participants",e)),i.resolve(this.sinch.messageClient.messageBuffert[e.mxpSessionId])}.bind(this)).fail(function(e){i.reject(e)}).progress(function(e){i.notify(e)}.bind(this)),i.promise},MXP.prototype.sendMsgAck=function(e){var t=new MXPMessageObj({mxpSessionId:e.mxpSessionId});t.decrypted.md=2,t.decrypted.bt=e.decrypted.bt,t.decrypted.bv=MXPMessagingVersion,t.transportObj=e.transportObj;var i=[];t.transportObj.participants.forEach(function(t){t.channel==e.decrypted.fs&&i.push(t)}.bind(this)),t.transportObj.participants=i,Object.keys(t.transportObj.participants).length>0&&(this.sinch.log(new MXPLog("Will send Ack",t)),this.sendMXP(t).then(function(t){this.sinch.log(new MXPLog("Sent ack",[e.decrypted.fu,t.channel]))}.bind(this)).fail(function(e){console.error(e)}))};var verifyMessagingCapability=function(){if(void 0===this.sinch.messageClient){var e=new MXPError(ErrorDomain.ErrorDomainCapability,ErrorCode.CapabilityCapabilityMissing,"Can not process IM messages. Messaging capability not set.");this.sinch.log(e)}},MXPIMHandlers={none:function(e){console.log("Null handler for message object: ",e)},"1_msg":function(e){verifyMessagingCapability.call(this),this.sinch.messageClient&&this.sinch.messageClient.handleMessage(e)&&e.decrypted.fu!=this.user.userId&&this.sendMsgAck(e)},"2_msg":function(e){this.sinch.messageClient&&this.sinch.messageClient.ackMsg(e.decrypted.fu,e.mxpSessionId)}};MXPHandlers=MXPHandlers||{};for(var key in MXPIMHandlers)MXPHandlers[key]=MXPIMHandlers[key];module.exports=Sinch,module.exports.MessageClient=MessageClient,module.exports.Message=Message,module.exports.Call=Call,module.exports.CallClient=CallClient,module.exports.Verification=Verification,module.exports.CallDetails=CallDetails,module.exports.MessageDeliveryInfo=MessageDeliveryInfo,module.exports.PAPIDefs=PAPI;